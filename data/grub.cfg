export disable_gfxterm
export menu_current
export from
export fromiso
export bootlang
export keyboard
export timezone
export hwclock
export def_bootlang
export def_keyboard
export def_timezone
export def_hwclock
export menu_color_normal
export menu_color_highlight

function menu_reload {
  configfile $prefix/grub.cfg
}

function is_efi {
  if [ "$grub_platform" = "efi" ]; then
    return true
  fi
  return false
}

function efi_detect {
  if is_efi ; then
    submenu "Detect EFI bootloaders" {
      efi_found=false

      for efi in (*,gpt*)/efi/*/*.efi (*,gpt*)/efi/*/*/*.efi (*,gpt*)/*.efi (*,gpt*)/*/*.efi ; do
        regexp --set=1:efi_device '^\((.*)\)/' "$efi"
        if [ -e "$efi" ]; then
          efi_found=true

          menuentry "$efi" "$efi_device" {
            root="$2"
            chainloader "$1"
          }
        fi
      done

      if [ "$efi_found" != true ]; then
        menuentry "No EFI files detected." {
          menu_reload
        }
      else
        menuentry "Cancel" {
          menu_reload
        }
      fi
    }
  fi
}

function lang_setup {
  source ${prefix}/locales/${1}
  menu_reload
}

function lang_menu {
  menuentry "lang=$ll" "$ll" {
    lang_setup "${2}"
  }
}

function locale_menu {
  submenu "lang=${def_bootlang}" {
    default=0
    menuentry "lang=${def_bootlang}" {
      menu_reload
    }
    submenu "English" {
      for ll in en_US en_AU en_CA en_GB en_IE en_IN en_NZ en_ZA ; do
        lang_menu ${ll}
      done
    }
    menuentry "Deutsch" {
      lang_setup "de_DE"
    }
    menuentry "Ελληνικά" {
      lang_setup "el_GR"
    }
  }
  submenu "keyboard=${def_keyboard}" {
    default=0
    menuentry "Cancel (${def_keyboard})" {
      menu_reload
    }
    for kk in us de gb ie ; do
      menuentry "keytable=${kk}" "${kk}" {
        def_keyboard="${2}"
        keyboard="keytable=${2}"
        menu_reload
      }
    done
  }
  submenu "tz=${def_timezone}" {
    default=0
    menuentry "Cancel (${def_timezone})" {
      menu_reload
    }
    for tt in Africa Americas Antartica "Artic Ocean" Asia "Atlantic Ocean" Australia Europe "Indian Ocean" "Pacific Ocean" Posix; do
      submenu "${tt}" {
        source "${prefix}/tz/${1}"
      }
    done
  }
  if [ "${def_hwclock}" = "utc" ] ; then
    menuentry "Change hwclock to localtime" {
      hwclock=""
      def_hwclock=""
      menu_reload
    }
  else
    menuentry "Change hwclock to UTC" {
      hwclock="utc"
      def_hwclock="utc"
      menu_reload
    }
  fi
}

function locale_defaults {
  if [ -z "$def_bootlang" ] ; then
    def_bootlang="en_US"
    def_keyboard="us"
    def_timezone="UTC"
    def_hwclock="utc"
  fi
}

insmod regexp
if ! is_efi ; then
  insmod part_gpt
fi

timeout=30

if keystatus --shift; then
  disable_gfxterm=true
fi

if [ "${disable_gfxterm}" != "true" ]; then
  insmod all_video
  if loadfont $prefix/unicode.pf2 ; then
    gfxmode=640x480
    insmod gfxterm
    if ! is_efi; then
      insmod vbe
    fi
    terminal_output --append gfxterm
  else
    disable_gfxterm=true
  fi
fi

menu_color_normal=cyan/blue
menu_color_highlight=white/blue

if [ -n "${iso_path}" ]; then 
  fromiso="fromiso=${iso_path}"
fi

for kopt in "$from" "$fromiso" "$bootlang" "$keyboard" "$timezone" "$hwclock"; do
  if [ -n "$kopt" ]; then
    kopts="${kopts} ${kopt}"
  fi
done

function main {
  default=4
  locale_menu
  source $prefix/kernels.cfg
  efi_detect
}

if [ "${menu_current}" = "" ]; then
  menu_current="main"
fi

locale_defaults

${menu_current}
